# 原型生成器升级说明

## 📋 升级概述

本次升级主要解决了两个核心问题：

1. **避免代码重复问题**：重新设计了分步骤生成逻辑，确保HTML、CSS、JS各司其职
2. **实现实时预览功能**：集成了QWebEngineView，支持生成过程中的实时预览

## 🆕 新功能特性

### 1. 分步骤模块化生成

原型生成现在分为5个清晰的步骤：

```
📋 第1步: 生成框架设计 (10-25%)
├─ 设计理念制定
└─ 组件结构规划

🏗️ 第2步: 构建HTML结构 (25-40%)
├─ 纯净的HTML结构
└─ 语义化标签设计

🎨 第3步: 设计样式系统 (40-65%)
├─ 完整的CSS样式
└─ 响应式设计支持

⚡ 第4步: 实现交互功能 (65-85%)
├─ JavaScript交互逻辑
└─ 用户体验优化

✨ 第5步: 完善整合 (85-100%)
├─ 实施建议生成
└─ 最终优化建议
```

### 2. 实时预览系统

- **步骤间预览**：每完成一个步骤自动更新预览
- **WebEngine集成**：使用QWebEngineView渲染真实HTML
- **自动刷新**：支持自动/手动刷新模式
- **预览状态指示**：清晰显示当前预览状态

### 3. 代码分离保证

严格的代码分离规则：

| 生成阶段 | 内容要求 | 禁止内容 |
|---------|---------|---------|
| HTML生成 | 纯净结构+语义化标签 | ❌ 内联样式、❌ 脚本代码 |
| CSS生成 | 完整样式系统 | ❌ HTML标签、❌ JS代码 |
| JS生成 | 交互功能实现 | ❌ HTML结构、❌ CSS样式 |

## 🔧 使用方法

### 启用实时预览

在原型生成设置中勾选"实时预览"选项：

```python
input_data = {
    'prototype_type': '网页',
    'framework': 'HTML/CSS/JS', 
    'style_framework': 'Bootstrap',
    'responsive': True,
    'accessibility': True,
    'realtime_preview': True  # 启用实时预览
}
```

### 监听步骤完成事件

```python
# 连接步骤完成信号
generator.step_completed.connect(on_step_completed)
generator.preview_ready.connect(on_preview_ready)

def on_step_completed(step_name, step_result):
    print(f"步骤完成: {step_name}")
    # step_result包含该步骤的HTML、CSS、JS和预览内容

def on_preview_ready(html_content):
    print(f"预览更新: {len(html_content)} 字符")
    # 可以在这里更新UI预览
```

## 🎯 界面改进

### 预览标签页优化

- **置于首位**：预览标签页移至最前面，突出实时预览功能
- **预览控制**：增加刷新按钮和自动刷新开关
- **状态指示**：显示预览更新状态和步骤进度

### 生成设置增强

- **实时预览选项**：新增实时预览开关
- **分组优化**：将设置分为"生成设置"和"生成控制"两组
- **状态反馈**：更详细的生成进度和状态显示

## 📊 技术改进

### 1. 避免重复的Prompt设计

每个步骤都有专门设计的prompt：

```python
# HTML步骤 - 专注结构
"""
生成规则：
1. 只关注HTML结构：不要在HTML中内联任何CSS样式或JavaScript代码
2. 语义化标签：使用正确的HTML5语义化标签  
3. 清晰的class命名：使用一致的CSS class命名规范
4. 无样式代码：绝对不要在HTML中写任何style属性或<style>标签
5. 无脚本代码：绝对不要在HTML中写任何<script>标签或onclick等事件
"""

# CSS步骤 - 专注样式
"""
生成规则：
1. 纯CSS代码：只生成CSS，不要任何HTML或JavaScript代码
2. 现代化设计：使用现代CSS特性，美观的视觉效果
3. 组件样式：为每个组件创建完整的样式定义
"""

# JS步骤 - 专注交互
"""
生成规则：
1. 纯JavaScript代码：只生成JS，不要任何HTML或CSS代码
2. 功能导向：实现组件的核心交互功能
3. 事件处理：添加必要的事件监听器
"""
```

### 2. 组件结构优化

新的组件数据结构：

```python
component = {
    'name': '组件名称',
    'type': '组件类型', 
    'description': '组件描述',
    'functions': ['功能1', '功能2']  # 替代原来的props/events
}
```

### 3. 预览生成系统

支持多种预览模式：

- **步骤预览**：每个步骤完成时的临时预览
- **最终预览**：包含完整HTML+CSS+JS的可交互预览
- **文件导出**：支持完整HTML文件导出

## 🛠 依赖更新

新增依赖项：

```text
PyQtWebEngine>=5.15.0  # 用于HTML预览功能
```

## 🧪 测试验证

运行增强功能测试：

```bash
python test_prototype_generator.py
```

测试包含：

1. **分步骤生成测试**：验证5个步骤是否正确完成
2. **代码分离检查**：确保HTML/CSS/JS没有互相包含
3. **实时预览测试**：验证预览功能正常工作
4. **组件结构测试**：检查组件化设计是否正确

## 📈 性能优化

### 1. 内存管理

- 使用临时文件系统管理预览内容
- 适时清理临时资源
- 优化大文件处理

### 2. 生成效率

- 分步骤生成减少重复工作
- 缓存生成上下文避免重复解析
- 流式输出提升用户体验

## 🔮 未来计划

1. **模板系统**：支持自定义原型模板
2. **组件库**：内置常用组件库支持
3. **协作功能**：支持多人协作编辑
4. **版本控制**：原型版本管理和回滚
5. **导出增强**：支持更多格式导出（Figma、Sketch等）

## 🐛 已知问题

1. **WebEngine依赖**：如果PyQtWebEngine未安装，预览功能会降级
2. **临时文件**：长期运行可能产生较多临时文件
3. **大型项目**：复杂项目的生成时间较长

## 📚 使用建议

1. **首次使用**：建议从简单项目开始，熟悉分步骤生成流程
2. **实时预览**：对于复杂项目，可以关闭实时预览以提升性能
3. **代码检查**：生成后建议检查代码分离情况，确保质量
4. **迭代优化**：可以基于生成结果进行多轮优化

---

**升级完成** ✅ 原型生成器现在支持真正的分步骤生成和实时预览功能！ 